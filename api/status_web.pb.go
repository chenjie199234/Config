// Code generated by protoc-gen-go-web. DO NOT EDIT.

package api

import (
	context "context"
	json "encoding/json"
	fmt "fmt"
	bufpool "github.com/chenjie199234/Corelib/bufpool"
	common "github.com/chenjie199234/Corelib/util/common"
	metadata "github.com/chenjie199234/Corelib/util/metadata"
	web "github.com/chenjie199234/Corelib/web"
	io "io"
	http "net/http"
)

var WebPathStatusPing = "/config.Status/Ping"

// StatusWebClient is the client API for Status service.
type StatusWebClient interface {
	//ping check server's health
	Ping(context.Context, *Pingreq) (*Pingresp, error)
}

type statusWebClient struct {
	cc *web.WebClient
}

func NewStatusWebClient(c *web.ClientConfig, selfgroup, selfname string) (StatusWebClient, error) {
	cc, e := web.NewWebClient(c, selfgroup, selfname, Group, Name)
	if e != nil {
		return nil, e
	}
	return &statusWebClient{cc: cc}, nil
}

func (c *statusWebClient) Ping(ctx context.Context, req *Pingreq) (*Pingresp, error) {
	if req == nil {
		return nil, fmt.Errorf("bad request:nil")
	}
	var header http.Header
	if realcrx, ok := ctx.(*web.Context); ok {
		header = realcrx.GetHeaders()
	}
	if header == nil {
		header = make(http.Header)
	}
	if md := metadata.GetAllMetadata(ctx); len(md) != 0 {
		d, _ := json.Marshal(md)
		header.Set("Metadata", common.Byte2str(d))
	}
	header.Set("Content-Type", "application/x-www-form-urlencoded")
	buf := bufpool.GetBuffer()
	if req.Timestamp != 0 {
		buf.Append("&")
		buf.Append("timestamp")
		buf.Append("=")
		buf.Append(req.Timestamp)
	}
	if buf.Len() > 0 {
		buf.Bytes()[0] = '?'
	}
	callback, e := c.cc.Get(ctx, 200000000, WebPathStatusPing+buf.String(), header)
	bufpool.PutBuffer(buf)
	if e != nil {
		return nil, fmt.Errorf("call error:" + e.Error())
	}
	defer callback.Body.Close()
	data, e := io.ReadAll(callback.Body)
	if e != nil {
		return nil, fmt.Errorf("read response error:" + e.Error())
	}
	if callback.StatusCode/100 == 5 || callback.StatusCode/100 == 4 {
		return nil, fmt.Errorf(common.Byte2str(data))
	}
	resp := new(Pingresp)
	if len(data) > 0 {
		if e = json.Unmarshal(data, resp); e != nil {
			return nil, fmt.Errorf("response data format errors" + e.Error())
		}
	}
	return resp, nil
}

// StatusWebServer is the server API for Status service.
type StatusWebServer interface {
	//ping check server's health
	Ping(context.Context, *Pingreq) (*Pingresp, error)
}

func _Status_Ping_WebHandler(handler func(context.Context, *Pingreq) (*Pingresp, error)) web.OutsideHandler {
	return func(ctx *web.Context) {
		req := new(Pingreq)
		if ctx.GetMethod() != http.MethodGet && ctx.GetContentType() == "application/json" {
			data, e := ctx.GetBody()
			if e != nil {
				ctx.WriteString(http.StatusInternalServerError, "server error:read request body error:"+e.Error())
				return
			}
			if len(data) != 0 {
				if e := json.Unmarshal(data, req); e != nil {
					ctx.WriteString(http.StatusBadRequest, "bad request:json format error:"+e.Error())
					return
				}
			}
		} else {
			if e := ctx.ParseForm(); e != nil {
				ctx.WriteString(http.StatusBadRequest, "bad request:form format error:"+e.Error())
				return
			}
			buf := bufpool.GetBuffer()
			buf.Append("{")
			hasfields := false
			if temp := ctx.GetForm("timestamp"); len(temp) != 0 {
				buf.Append("\"timestamp\":")
				buf.Append(temp)
				buf.Append(",")
				hasfields = true
			}
			if hasfields {
				buf.Bytes()[buf.Len()-1] = '}'
			} else {
				buf.Append("}")
			}
			if buf.Len() > 2 {
				if e := json.Unmarshal(buf.Bytes(), req); e != nil {
					ctx.WriteString(http.StatusBadRequest, "bad request:form format error:"+e.Error())
					return
				}
			}
			bufpool.PutBuffer(buf)
		}
		resp, e := handler(ctx, req)
		if e != nil {
			ctx.WriteString(http.StatusInternalServerError, e.Error())
		} else if resp == nil {
			ctx.WriteString(http.StatusOK, "{}")
		} else {
			respd, _ := json.Marshal(resp)
			ctx.Write(http.StatusOK, respd)
		}
	}
}
func RegisterStatusWebServer(engine *web.WebServer, svc StatusWebServer, allmids map[string]web.OutsideHandler) error {
	//avoid lint
	_ = allmids
	if e := engine.Get(WebPathStatusPing, 200000000, _Status_Ping_WebHandler(svc.Ping)); e != nil {
		return e
	}
	return nil
}
